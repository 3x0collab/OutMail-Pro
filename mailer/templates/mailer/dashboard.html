{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OutMail Pro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    /* ========= GLOBAL ========= */
    body {
      margin: 0;
      font-family: "Poppins", "Segoe UI", sans-serif;
      color: #222;
      overflow-x: hidden;
      height: 100vh;
      background: linear-gradient(135deg, #e6f8ed, #f3fdf8, #e8f9ee);
      background-size: 300% 300%;
      animation: moveBg 12s ease infinite;
    }

    @keyframes moveBg {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .glass {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(18px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      border-radius: 18px;
      animation: fadeUp 0.7s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========= SIDEBAR ========= */
    .sidebar {
      position: fixed;
      top: 0; left: 0;
      width: 250px;
      height: 100vh;
      background: linear-gradient(180deg, #013901, #046d04);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
      box-shadow: 5px 0 20px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }

    .sidebar img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 2px solid #fff;
      margin-bottom: 10px;
    }

    .sidebar h3 {
      font-size: 18px;
      margin-bottom: 35px;
      font-weight: 600;
    }

    .sidebar a {
      color: #fff;
      text-decoration: none;
      display: block;
      width: 90%;
      padding: 12px 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin: 6px 0;
      font-weight: 500;
    }

    .sidebar a:hover, .sidebar a.active {
      background: rgba(255,255,255,0.2);
      transform: translateX(5px);
    }

    /* ========= MOBILE TOPBAR ========= */
    .mobile-topbar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(90deg, #024002, #048904);
      color: #fff;
      padding: 12px 16px;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }

    .mobile-topbar h5 {
      font-weight: 600;
      margin: 0;
    }

    .mobile-topbar .btn-sm {
      color: #fff;
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .mobile-topbar .btn-sm:hover {
      background: rgba(255,255,255,0.35);
    }

    /* ========= MAIN CONTENT ========= */
    .main {
      margin-left: 260px;
      padding: 50px 40px;
      animation: fadeUp 1s ease;
    }

    .page-title {
      font-weight: 700;
      color: #024002;
      margin-bottom: 25px;
    }

    .card {
      border: none;
      border-radius: 18px;
      padding: 30px;
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 22px rgba(0,0,0,0.08);
    }

    textarea, input.form-control {
      border-radius: 10px;
      border: 1px solid #cddccc;
      transition: border-color 0.3s;
    }

    textarea:focus, input.form-control:focus {
      border-color: #04a504;
      box-shadow: 0 0 0 0.15rem rgba(4, 165, 4, 0.15);
    }

    .btn-green {
      background: linear-gradient(90deg, #024002, #048904);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-green:hover {
      background: linear-gradient(90deg, #036a03, #05b005);
      transform: translateY(-2px);
    }

    footer {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-top: 50px;
      padding-bottom: 20px;
    }

    /* ========= RESPONSIVE ========= */
    @media (max-width: 992px) {
      .sidebar {
        display: none;
      }
      .main {
        margin: 0;
        padding: 90px 20px 30px;
      }
      .mobile-topbar {
        display: flex;
      }
    }

    @media (min-width: 993px) {
      .mobile-topbar {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <!-- MOBILE TOPBAR (Visible on Mobile Only) -->
  <div class="mobile-topbar">
    <h5><i class="bi bi-envelope-paper me-2"></i>OutMail Pro</h5>
    <div>
      <a href="{% url 'mailer:sent_logs' %}" class="btn btn-sm me-2"><i class="bi bi-journal-text"></i> Logs</a>
      <a href="{% url 'logout' %}" class="btn btn-sm"><i class="bi bi-box-arrow-right"></i> Logout</a>
    </div>
  </div>

  <!-- SIDEBAR (Hidden on Mobile) -->
  <div class="sidebar">
    <img src="https://pbs.twimg.com/media/G3C-pciWoAAoWlj?format=jpg&name=360x360" alt="Logo">
    <h3>OutMail Pro</h3>
    <a href="#" class="active"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
    <a href="{% url 'mailer:sent_logs' %}"><i class="bi bi-journal-text me-2"></i> Sent Logs</a>
    <a href="{% url 'logout' %}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">
    <h2 class="page-title"><i class="bi bi-send-fill me-2"></i> Bulk Mail Sender</h2>

    <div class="card glass mb-4">
      <form id="sendForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label class="fw-semibold">Recipients</label>
          <textarea name="recipients" class="form-control" rows="6" placeholder="Paste up to 3000 emails..."></textarea>
          <div class="form-text">Separate emails with commas, newlines, or spaces.</div>
        </div>

        <div class="mb-3">
          <input name="subject" class="form-control" placeholder="Subject">
        </div>

        <div class="mb-3">
          <label class="fw-semibold">Message (HTML Supported)</label>
          <textarea name="body" class="form-control" rows="10" placeholder="Type your email message here..."></textarea>
        </div>

        <div class="mb-3">
          <label class="fw-semibold">Attachments (Optional)</label>
          <input type="file" name="attachments" id="attachments" class="form-control" multiple>
        </div>

        <button id="sendBtn" type="submit" class="btn btn-green w-100 py-2">
          <i class="bi bi-envelope-paper me-1"></i> Send Emails
        </button>
      </form>
    </div>

    <!-- Progress Section -->
    <div id="progressArea" class="card glass" style="display:none;">
      <h5 class="fw-bold text-dark mb-3"><i class="bi bi-activity me-2"></i> Sending Progress</h5>
      <div class="progress mb-3" style="height: 25px;">
        <div id="progressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
      </div>
      <p id="progressText" class="small text-muted">Preparing...</p>
    </div>

    <footer>
      © 2025 OutMail Pro
    </footer>
  </div>

  <!-- SCRIPT -->
  <script>
    document.getElementById('sendForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;

      try {
        const res = await fetch("{% url 'mailer:start_send' %}", {
          method: "POST",
          body: data,
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        });
        const json = await res.json();

        if(json.ok && json.job_id){
          document.getElementById('progressArea').style.display = 'block';
          pollProgress(json.job_id, json.total);
        } else {
          alert(json.error || 'Error starting task');
          sendBtn.disabled = false;
        }
      } catch(err) {
        alert('Error sending request');
        sendBtn.disabled = false;
      }
    });

    function pollProgress(jobId, total){
      const bar = document.getElementById('progressBar');
      const text = document.getElementById('progressText');

      const interval = setInterval(async () => {
        try {
          const res = await fetch(`/mailer/progress/${jobId}/`);
          const j = await res.json();
          const sent = j.sent || 0;
          const failed = j.failed || 0;
          const percent = total ? Math.round((sent + failed) / total * 100) : 0;

          bar.style.width = percent + '%';
          bar.textContent = percent + '%';
          text.innerText = `${sent} sent, ${failed} failed — ${percent}% done`;

          if(j.completed || (sent + failed >= total)){
            clearInterval(interval);
            bar.style.width = '100%';
            text.innerText = `✅ Done — ${sent} sent, ${failed} failed`;
            document.getElementById('sendBtn').disabled = false;
          }
        } catch(err){
          clearInterval(interval);
          text.innerText = 'Error fetching progress';
          document.getElementById('sendBtn').disabled = false;
        }
      }, 2000);
    }
  </script>
</body>
</html>
