{% extends "mailer/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center rounded-top-4" style="background-color: #024002 !important;">
      <h4 class="mb-0"><i class="bi bi-envelope-paper"></i> Send Bulk Email</h4>
      <a href="{% url 'logout' %}" class="btn btn-light btn-sm">Logout</a>
    </div>
    <div class="card-body">
      <form id="sendForm">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label fw-semibold text-dark">{{ form.recipients.label }}</label>
          {{ form.recipients }}
          <small class="text-muted d-block mt-1">{{ form.recipients.help_text }}</small>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold text-dark">{{ form.subject.label }}</label>
          {{ form.subject }}
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold text-dark">{{ form.body.label }}</label>
          {{ form.body }}
        </div>

        <button id="sendBtn" type="submit" class="btn text-white w-100 py-2 fw-semibold shadow-sm" style="background-color: #024002;">ðŸ“¤ Send Emails</button>
      </form>

      <div id="progressArea" class="mt-4" style="display:none;">
        <h5 class="fw-bold text-dark mb-2">Progress</h5>
        <div class="bg-light p-3 rounded border">
          <div id="progressText" class="text-secondary mb-2 small">Starting...</div>
          <div class="progress" style="height: 24px; border-radius: 12px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width:0%">0%</div>
          </div>
        </div>
        <div id="errors" class="mt-3 text-danger small"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.getElementById('sendForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const sendBtn = document.getElementById('sendBtn');
  sendBtn.disabled = true;

  try {
    const res = await fetch("{% url 'mailer:start_send' %}", {
      method: "POST",
      body: data,
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    });
    const json = await res.json();

    if(json.ok && json.job_id){
      document.getElementById('progressArea').style.display = 'block';
      pollProgress(json.job_id, json.total);
    } else {
      alert(json.error || 'Error starting task');
      sendBtn.disabled = false;
    }
  } catch(err) {
    alert('Error sending request');
    sendBtn.disabled = false;
  }
});

function pollProgress(jobId, total){
  const bar = document.getElementById('progressBar');
  const text = document.getElementById('progressText');

  const interval = setInterval(async () => {
    try {
      const res = await fetch(`/mailer/progress/${jobId}/`);
      const j = await res.json();
      const sent = j.sent || 0;
      const failed = j.failed || 0;
      const percent = total ? Math.round((sent + failed) / total * 100) : 0;

      bar.style.width = percent + '%';
      bar.textContent = percent + '%';
      text.innerText = `${sent} sent, ${failed} failed â€” ${percent}% done`;

      if(j.completed || (sent + failed >= total)){
        clearInterval(interval);
        bar.style.width = '100%';
        text.innerText = `âœ… Done â€” ${sent} sent, ${failed} failed`;
        sendBtn.disabled = false;
      }
    } catch(err){
      console.error('Error polling progress', err);
      clearInterval(interval);
      text.innerText = 'Error fetching progress';
      sendBtn.disabled = false;
    }
  }, 2000);
}
</script>
{% endblock %}
